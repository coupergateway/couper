name: Claude Code Assistant

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  claude-implement:
    name: "Claude: Implement Issue"
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      (github.event.label.name == 'claude-implement' || github.event.label.name == 'claude-implement-opus') &&
      github.actor == 'malud'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: go mod download

      - name: Determine model args
        id: model
        run: |
          if [[ "${{ github.event.label.name }}" == "claude-implement-opus" ]]; then
            echo "model=opus" >> $GITHUB_OUTPUT
          else
            echo "model=sonnet" >> $GITHUB_OUTPUT
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          prompt: |
            ISSUE TO IMPLEMENT:
            Repository: ${{ github.repository }}
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            URL: ${{ github.event.issue.html_url }}

            Issue Description:
            ${{ github.event.issue.body }}

            ---

            STEP 1 - LOAD CONTEXT:
            First, run /init-context to load full project documentation from CLAUDE.md and linked files.

            STEP 2 - ASSESS ISSUE:
            Review the issue description above. If it lacks specific requirements, acceptance criteria, or context needed to implement correctly, comment on the issue asking for clarification instead of proceeding. Do not guess at requirements.

            STEP 3 - IMPLEMENT:
            If the issue is clear enough, implement the changes following these requirements:
            1. Follow patterns in CLAUDE.md, docs/ARCHITECTURE.md, docs/GO_GUIDELINES.md
            2. All tests must pass: `go test -v -timeout 300s -race ./...`
            3. Run `go fmt ./...` and `go vet ./...` before committing
            4. Update CHANGELOG.md under [Unreleased]
            5. Add integration tests for new features

            TESTING:
            - Add tests for both happy path AND unhappy path (error cases, edge cases, invalid input)
            - Test coverage should verify the feature works AND fails gracefully
            - Follow existing test patterns in server/http_integration_test.go

            STEP 4 - VERIFY & CREATE PR:
            - `make build` succeeds
            - Run ONLY tests you created or modified (not `make test` - full suite runs on PR):
              Use `go test -v -timeout 90s -race -count=1 ./path/to/package -run TestName`
              to run specific new/changed tests
            - Run `make generate-docs` to update documentation for new/changed config attributes
            - Run `go fmt ./...` and `go vet ./...`
            - Create a PR with a clear description
            - After creating the PR, output the PR URL and stop immediately. Do not continue working.
          claude_args: |
            --model ${{ steps.model.outputs.model }}
            --max-turns 75
            --allowedTools "Bash(*)" "Edit" "Write" "Read" "Glob" "Grep" "Skill" "WebFetch"

  claude-respond:
    name: "Claude: Respond to Mention"
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'malud'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: go mod download

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --max-turns 25
            --allowedTools "Bash(*)" "Edit" "Write" "Read" "Glob" "Grep" "Skill" "WebFetch"
