name: npm-publish

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: Package name
        type: choice
        default: "couper"
        required: true
        options:
        - "couper"
        - "@avenga/couper"
      package-version:
        description: Package version
        required: true
        default: ${{ GITHUB_REF_NAME }}
        type: string
      token-name:
        description: secret containing npm publish token
        type: string
        default: NPM_TOKEN
jobs:
  npm:
    name: 'update npm package'
    runs-on: ubuntu-latest
    steps:
      - name: 'checkout'
        uses: actions/checkout@v2
      - name: 'prepare package'
        run: |
          cp LICENSE .npm
          curl -L https://github.com/malud/temgo/releases/download/0.2.1/tg -o tg
          chmod +x tg
          PACKAGE_VERSION=${PACKAGE_VERSION#v} ./tg -i .npm/package.json
          cat .npm/package.json
      - name: 'setup node'
        uses: actions/setup-node@v1
        with:
          node-version: 10
      - name: 'publish to npm'
        uses: JS-DevTools/npm-publish@v1
        with:
          package: ".npm/package.json"
          access: "public"
          token: ${{ secrets[github.event.inputs.token-name] }}
          dry-run: true
      - name: 'test published package'
        run: |
          npm install ${{ github.event.inputs.package-name }}
          $(npm bin)/couper version
