# JWT

The `jwt` block lets you configure JSON Web Token access control for your gateway.
Like all [Access Control](#access-control) types, the `jwt` block is defined in
the [Definitions Block](#definitions-block) and can be referenced in all configuration blocks by its
required _label_.

Since responses from endpoints protected by JWT access controls are not publicly cacheable, a `Cache-Control: private` header field is added to the response, unless this feature is disabled with `disable_private_caching = true`.

| Block name | Context                                 | Label            | Nested block(s)                                                                  |
|:-----------|:----------------------------------------|:-----------------|:---------------------------------------------------------------------------------|
| `jwt`      | [Definitions Block](#definitions-block) | &#9888; required | [JWKS `backend`](#backend-block), [Error Handler Block(s)](#error-handler-block) |

| Attribute(s)              | Type                  | Default | Description                                                                                                   | Characteristic(s)                                                                                                                                                            | Example                                                                       |
|:--------------------------|:----------------------|:--------|:--------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------|
| `cookie`                  | string                | -       | Read token value from a cookie.                                                                               | cannot be used together with `header` or `token_value`                                                                                                                       | `cookie = "AccessToken"`                                                      |
| `custom_log_fields`       | object                | -       | Defines log fields for [Custom Logging](LOGS.md#custom-logging).                                              | &#9888; Inherited by nested blocks.                                                                                                                                          | -                                                                             |
| `header`                  | string                | -       | Read token value from a request header field.                                                                 | &#9888; Implies `Bearer` if `Authorization` (case-insensitive) is used, otherwise any other header name can be used. Cannot be used together with `cookie` or `token_value`. | `header = "Authorization"`                                                    |
| `token_value`             | string                | -       | expression to obtain the token                                                                                | cannot be used together with `cookie` or `header`                                                                                                                            | `token_value = request.form_body.token[0]`                                    |
| `key`                     | string                | -       | Public key (in PEM format) for `RS*` and `ES*` variants or the secret for `HS*` algorithm.                    | -                                                                                                                                                                            | -                                                                             |
| `key_file`                | string                | -       | Optional file reference instead of `key` usage.                                                               | -                                                                                                                                                                            | -                                                                             |
| `signature_algorithm`     | string                | -       | -                                                                                                             | Valid values: `"RS256"`, `"RS384"`, `"RS512"`, `"HS256"`, `"HS384"`, `"HS512"`, `"ES256"`, `"ES384"`, `"ES512"`                                                              | -                                                                             |
| `claims`                  | object                | -       | Object with claims that must be given for a valid token (equals comparison with JWT payload).                 | The claim values are evaluated per request.                                                                                                                                  | `claims = { pid = request.path_params.pid }`                                  |
| `required_claims`         | string                | -       | List of claim names that must be given for a valid token                                                      | -                                                                                                                                                                            | `required_claims = ["roles"]`                                                 |
| `beta_permissions_claim`  | string                | -       | name of claim containing the granted permissions                                                              | The claim value must either be a string containing a space-separated list of permissions or a list of string permissions                                                     | `beta_permissions_claim = "scope"`                                            |
| `beta_permissions_map`    | object (string)       | -       | mapping of granted permissions to additional granted permissions                                              | Maps values from `beta_permissions_claim` and those created from `beta_roles_map`. The map is called recursively.                                                            | `beta_permissions_map = { p1 = ["p3", "p4"], p2 = ["p5"] }`                   |
| `beta_roles_claim`        | string                | -       | name of claim specifying the roles of the user represented by the token                                       | The claim value must either be a string containing a space-separated list of role values or a list of string role values                                                     | `beta_roles_claim = "roles"`                                                  |
| `beta_roles_map`          | object (string)       | -       | mapping of roles to granted permissions                                                                       | Non-mapped roles can be assigned with `*` to specific permissions.                                                                                                           | `beta_roles_map = { role1 = ["p1", "p2"], role2 = ["p3"], "*" = ["public"] }` |
| `jwks_url`                | string                | -       | URI pointing to a set of [JSON Web Keys (RFC 7517)](https://datatracker.ietf.org/doc/html/rfc7517)            | -                                                                                                                                                                            | `jwks_url = "http://identityprovider:8080/jwks.json"`                         |
| `jwks_ttl`                | [duration](#duration) | `"1h"`  | Time period the JWK set stays valid and may be cached.                                                        | -                                                                                                                                                                            | `jwks_ttl = "1800s"`                                                          |
| `jwks_max_stale`          | [duration](#duration) | `"1h"`  | Time period the cached JWK set stays valid after its TTL has passed.                                          | -                                                                                                                                                                            | `jwks_max_stale = "45m"`                                                      |
| `backend`                 | string                | -       | [backend reference](#backend-block) for enhancing JWKS requests                                               | -                                                                                                                                                                            | `backend = "jwks_backend"`                                                    |
| `disable_private_caching` | bool                  | `false` | If set to `true`, Couper does not add the `private` directive to the `Cache-Control` HTTP header field value. | -                                                                                                                                                                            | -                                                                             |

The attributes `header`, `cookie` and `token_value` are mutually exclusive.
If all three attributes are missing, `header = "Authorization"` will be implied, i.e. the token will be read from the incoming `Authorization` header.

If the key to verify the signatures of tokens does not change over time, it should be specified via either `key` or `key_file` (together with `signature_algorithm`).
Otherwise, a JSON web key set should be referenced via `jwks_url`; in this case, the tokens need a `kid` header.

A JWT access control configured by this block can extract permissions from

- the value of the claim specified by `beta_permissions_claim` and
- the result of mapping the value of the claim specified by `beta_roles_claim` using the `beta_roles_map`.

The `jwt` block may also be referenced by the [`jwt_sign()` function](#functions), if it has a `signing_ttl` defined. For `HS*` algorithms the signing key is taken from `key`/`key_file`, for `RS*` and `ES*` algorithms, `signing_key` or `signing_key_file` have to be specified.

**Note:** A `jwt` block with `signing_ttl` cannot have the same label as a `jwt_signing_profile` block.

| Attribute(s)       | Type                  | Default | Description                                               | Characteristic(s) | Example |
|:-------------------|:----------------------|:--------|:----------------------------------------------------------|:------------------|:--------|
| `signing_key`      | string                | -       | Private key (in PEM format) for `RS*` and `ES*` variants. | -                 | -       |
| `signing_key_file` | string                | -       | Optional file reference instead of `signing_key` usage.   | -                 | -       |
| `signing_ttl`      | [duration](#duration) | -       | The token's time-to-live (creates the `exp` claim).       | -                 | -       |
